name: Build openDAQ packages

on:
  push:
    branches: [main, release/**]

  workflow_dispatch:

env:
  cmake_preset: package
  build_path: ${{ github.workspace }}/build
  package_path: ${{ github.workspace }}/build/_packages
  wheels_path: ${{ github.workspace }}/build/wheels
  package_path_rel: build/_packages # WA for https://github.com/actions/checkout/issues/785
  vm_name: device_simulator
  simulator_app_artifact: SimulatorApp
  python_version_build: 3.11
  python_versions: 3.8 3.9 3.10 3.11 3.12 3.13 3.14
  windows_x64_artifact: SdkWindows64
  linux_x64_artifact: SdkLinux64

jobs:
  package_windows:
    runs-on: ${{ matrix.runner }}
    name: ${{ matrix.name }}

    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}-${{ matrix.name }}
      cancel-in-progress: true
    timeout-minutes: 360
    strategy:
      fail-fast: false
      matrix:
        # https://docs.github.com/en/actions/using-github-hosted-runners/about-github-hosted-runners
        include:
          - name: Windows VS 2022 x64 Release
            runner: windows-latest
            cmake-generator: "Visual Studio 17 2022"
            cmake-build-type: Release
            cmake-defines: -DDAQMODULES_PARQUET_RECORDER_MODULE=ON
            cpack-generator: NSIS
            enable-32bit: false
            generate-python-bindings: true
            generate-csharp-bindings: true
          - name: Windows VS 2022 Win32 Release
            runner: windows-latest
            cmake-generator: "Visual Studio 17 2022"
            cmake-build-type: Release
            cmake-defines:
            cpack-generator: NSIS
            enable-32bit: true
            generate-python-bindings: false
            generate-csharp-bindings: false

    outputs:
      # trick for reusable workflow in dotnet_bindings because cannot use env context in "with:"
      windows_x64_artifact_name: ${{ env.windows_x64_artifact }}

    env:
      short_sha: 'package'  # for .NET Bindings build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build SDK
        id: build-sdk
        uses: ./.github/actions/build-sdk
        with:
          additional-dependencies: nsis
          cmake-generator: ${{ matrix.cmake-generator }}
          cmake-config-preset: ${{ env.cmake_preset }}
          cmake-config-args: ${{ matrix.cmake-defines }}
          cmake-build-type: ${{ matrix.cmake-build-type }}
          enable-32bit: ${{ matrix.enable-32bit == true }}
          cpack-generator: ${{ matrix.cpack-generator }}
          generate-csharp-bindings: false
          generate-python-bindings: false
          upload-artifact: true

      - name: Package Python Bindings
        if: matrix.generate-python-bindings == true
        uses: ./.github/actions/package-bindings-python
        with:
          python-versions: ${{ env.python_versions }}
          build-path: ${{ steps.build-sdk.outputs.build-path }}
          cmake-build-type: ${{ matrix.cmake-build-type }}
          upload-artifact: true

      - name: Build C# Bindings
        id: package-csharp-bindings
        if: matrix.generate-csharp-bindings == true
        uses: ./.github/actions/package-bindings-csharp
        with:
          build-path: ${{ steps.build-sdk.outputs.build-path }}
          cmake-build-type: ${{ matrix.cmake-build-type }}
          package-artifact-name: ${{ env.windows_x64_artifact }}
          package-artifact-retention-days: 1

  package_linux:
    runs-on: ${{ matrix.runner }}
    name: ${{ matrix.name }}

    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}-${{ matrix.name }}
      cancel-in-progress: true
    timeout-minutes: 180
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Linux x86_64 GCC Release
            runner: ubuntu-latest
            additional-dependencies: doxygen graphviz
            cmake-generator: Ninja
            cmake-build-type: Release
            cmake-defines: >-
              -DDAQMODULES_PARQUET_RECORDER_MODULE=ON
            generate-doxygen-doc: true
            generate-simulator-app: true
            generate-csharp-bindings: true
          - name: Linux ARM64 GCC Release
            runner: ubuntu-24.04-arm
            cmake-generator: Ninja
            cmake-build-type: Release
            cmake-defines:
            generate-doxygen-doc: false
            generate-simulator-app: false
            generate-csharp-bindings: false

    env:
      CC: gcc
      CXX: g++

    outputs:
      # trick for reusable workflow in dotnet_bindings because cannot use env context in "with:"
      linux_x64_artifact_name: ${{ env.linux_x64_artifact }}
      simulator_package_name: ${{ steps.set-simulator-output.outputs.name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build SDK
        id: build-sdk
        uses: ./.github/actions/build-sdk
        with:
          additional-dependencies: ${{ matrix.additional-dependencies }}
          cmake-generator: ${{ matrix.cmake-generator }}
          cmake-config-preset: ${{ env.cmake_preset }}
          cmake-config-args: ${{ matrix.cmake-defines }}
          cmake-build-type: ${{ matrix.cmake-build-type }}
          cpack-generator: DEB
          generate-python-bindings: false
          upload-artifact: true

      - name: Set simulator package output
        id: set-simulator-output
        if: matrix.generate-simulator-app == true
        run: echo "name=${{ steps.build-sdk.outputs.package-name }}" >> $GITHUB_OUTPUT

      - name: Build Documentation
        if: matrix.generate-doxygen-doc == true
        uses: ./.github/actions/build-doc
        with:
          build-path: ${{ steps.build-sdk.outputs.build-path }}
          artifact-name: API Reference

      - name: Build Simulator App
        if: matrix.generate-simulator-app == true
        shell: bash
        run: |
          cmake -B ${{ steps.build-sdk.outputs.build-path }} -DDAQSIMULATOR_ENABLE_SIMULATOR_APP=ON
          cmake --build ${{ steps.build-sdk.outputs.build-path }} --target application_simulator

      - name: Upload Simulator App
        if: matrix.generate-simulator-app == true
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.simulator_app_artifact }}
          path: ${{ steps.build-sdk.outputs.build-path }}/bin/application_simulator
          retention-days: 7

      - name: Upload binaries for .NET NuGet
        if: matrix.generate-csharp-bindings == true
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.linux_x64_artifact }}
          path: |
            ${{ steps.build-sdk.outputs.build-path }}/bin/*.so
            !${{ steps.build-sdk.outputs.build-path }}/**/opendaq.cpython*
            !${{ steps.build-sdk.outputs.build-path }}/**/*_test_dll.so
          retention-days: 1

  package_linux_wheels:
    runs-on: ubuntu-latest
    name: ${{ matrix.name }}

    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}-${{ matrix.name }}
      cancel-in-progress: true
    timeout-minutes: 180
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: manylinux_2_28 gcc Release
            image: quay.io/pypa/manylinux_2_28_x86_64
            cmake-generator: Ninja
            cmake-build-type: Release
            cmake-defines: >-
              -DDAQMODULES_PARQUET_RECORDER_MODULE=ON

    container:
      image: ${{ matrix.image }}
      env:
        TZ: Europe/Berlin
        CC: gcc
        CXX: g++

    steps:
      - name: Install basic dependencies
        run: |
          yum update -y
          yum install -y git

      - name: Checkout
        uses: actions/checkout@v4

      - name: Build SDK
        id: build-sdk
        uses: ./.github/actions/build-sdk
        with:
          additional-dependencies: ninja-build
          cmake-generator: ${{ matrix.cmake-generator }}
          cmake-config-preset: ${{ env.cmake_preset }}
          cmake-config-args: ${{ matrix.cmake-defines }}
          cmake-build-type: ${{ matrix.cmake-build-type }}
          generate-python-bindings: false
          generate-csharp-bindings: false
          skip-setup-ninja: true
          skip-setup-python: true

      - name: Package Python Bindings
        uses: ./.github/actions/package-bindings-python
        with:
          skip-setup-python: true
          python-versions: ${{ env.python_versions }}
          build-path: ${{ steps.build-sdk.outputs.build-path }}
          cmake-build-type: ${{ matrix.cmake-build-type }}
          upload-artifact: true

  package_macos_wheels:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.runner }}

    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}-${{ matrix.name }}
      cancel-in-progress: true
    timeout-minutes: 400
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: macOS x86_64 Clang Release
            runner: macos-15-intel
            cmake-generator: Ninja
            cmake-build-type: Release
            cmake-defines: >-
              -DDAQMODULES_PARQUET_RECORDER_MODULE=ON
              -DCMAKE_OSX_DEPLOYMENT_TARGET=10.15
          - name: macOS ARM64 Clang Release
            runner: macos-latest
            cmake-generator: Ninja
            cmake-build-type: Release
            cmake-defines: >-
              -DDAQMODULES_PARQUET_RECORDER_MODULE=ON
              -DCMAKE_OSX_DEPLOYMENT_TARGET=10.15

    env:
      CC: clang
      CXX: clang++

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build SDK
        id: build-sdk
        uses: ./.github/actions/build-sdk
        with:
          additional-dependencies: nsis
          cmake-generator: ${{ matrix.cmake-generator }}
          cmake-config-preset: ${{ env.cmake_preset }}
          cmake-config-args: ${{ matrix.cmake-defines }}
          cmake-build-type: ${{ matrix.cmake-build-type }}
          generate-csharp-bindings: false
          generate-python-bindings: false

      - name: Package Python Bindings
        uses: ./.github/actions/package-bindings-python
        with:
          python-versions: ${{ env.python_versions }}
          build-path: ${{ steps.build-sdk.outputs.build-path }}
          cmake-build-type: ${{ matrix.cmake-build-type }}
          upload-artifact: true
          package-artifact-name-include-arch: true

  package_macos_wheels_combined:
    name: Combine macOS wheels
    runs-on: ubuntu-latest
    needs: [package_macos_wheels]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect version
        id: detect
        uses: ./.github/actions/package-version-detect

      - name: Download macOS wheels
        uses: actions/download-artifact@v4
        with:
          pattern: opendaq-*-python-wheels-macos-*
          path: wheels
          merge-multiple: true

      - name: Upload combined wheels
        uses: actions/upload-artifact@v4
        with:
          name: opendaq-${{ steps.detect.outputs.version-full }}-python-wheels-macos
          path: wheels/*.whl

  simulator-build:
    runs-on: ubuntu-latest-4-cores
    name: Simulator build
    needs: [package_linux]

    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    timeout-minutes: 120
    env:
      simulator_directory: simulator

    defaults:
      run:
        working-directory: ${{ env.simulator_directory }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt update
          sudo apt install -y virtualbox vagrant

          # VirtualBox needs exclusive access to hardware virtualization (AMD-V/VT-x).
          # If KVM modules are loaded, VBoxManage fails with VERR_SVM_IN_USE.
          for mod in kvm_amd kvm_intel kvm; do
            if lsmod | grep -q "^${mod} "; then
              if sudo modprobe -r "${mod}"; then
                echo "Module ${mod} -- unload succeeded"
              else
                echo "::warning::Module ${mod} -- unload failed. VirtualBox may not start correctly."
              fi
            else
              echo "Module ${mod} -- not loaded"
            fi
          done

      - name: Download package
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.package_linux.outputs.simulator_package_name }}
          path: ${{ env.simulator_directory }}

      - name: Download simulator app
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.simulator_app_artifact }}
          path: ${{ env.simulator_directory }}

      - name: Display files in working directory
        run: ls -Rhl

      - name: Detect version
        id: detect
        uses: ./.github/actions/package-version-detect

      - name: Define simulator name
        id: simulator_name
        run: echo "SIMULATOR_NAME=opendaq-${{ steps.detect.outputs.version-full }}_${{ env.vm_name }}" >> "$GITHUB_OUTPUT"

      - name: Find binaries and run vagrant
        run: |
          debfiles=( *.deb )
          vagrant --version
          VM_NAME=${{ steps.simulator_name.outputs.SIMULATOR_NAME }} HOME_PATH=$HOME PACKAGE_NAME=${debfiles[0]} vagrant up
          VM_NAME=${{ steps.simulator_name.outputs.SIMULATOR_NAME }} HOME_PATH=$HOME PACKAGE_NAME=${debfiles[0]} vagrant halt

      - name: vboxmanage modify and compact
        run: |
          vboxmanage modifyvm ${{ steps.simulator_name.outputs.SIMULATOR_NAME }} --audio none --uart1 off --nic1 hostonly --hostonlyadapter1 "VirtualBox Host-Only Ethernet Adapter"
          vboxmanage modifymedium disk "${{ steps.simulator_name.outputs.SIMULATOR_NAME }}.vdi" --compact

      - name: vboxmanage check
        run: |
          vboxmanage list vms
          vboxmanage list hostonlyifs
          vboxmanage list hdds

      - name: export VM to .ova appliance
        run: |
          vboxmanage export ${{ steps.simulator_name.outputs.SIMULATOR_NAME }} -o ${{ steps.simulator_name.outputs.SIMULATOR_NAME }}.ova --options manifest,nomacs
          ls -hl ${{ steps.simulator_name.outputs.SIMULATOR_NAME }}.ova

      - name: Upload OVA image
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.simulator_name.outputs.SIMULATOR_NAME }}-ova-image
          path: simulator/${{ steps.simulator_name.outputs.SIMULATOR_NAME }}.ova
          retention-days: 7

      - name: Delete unused artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: ${{ env.simulator_app_artifact }}

  # using reusable workflow
  dotnet_bindings:
      name: .NET Bindings

      needs: [package_windows,package_linux]

      uses: ./.github/workflows/reusable_nuget_creation_and_test.yml
      with:
        # cannot use env context here, so use needs.<job>.outputs trick
        # windows_test_path: ''
        # linux_test_path: ''
        windows_x64_artifact_name:  ${{ needs.package_windows.outputs.windows_x64_artifact_name }}
        linux_x64_artifact_name:  ${{ needs.package_linux.outputs.linux_x64_artifact_name }}
      # -> output.nuget_artifact_name
